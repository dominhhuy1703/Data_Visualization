<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <link rel="icon" href="data:,">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>
    <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
    <script src="components/my-component/window-chart.js"></script>
    <script src="components/my-component/pie-chart.js"></script>
    <script src="components/my-component/bar-chart.js"></script>
    <script src="components/my-component/nodelink-chart.js"></script>
    <script src="components/my-component/map-chart.js"></script>
    <link rel="stylesheet" href="index.css">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0" />
    <title>Internship's Project</title>
  </head>
  <body>
    <div class="container">
        <!-- Using chart-selector to choose what chart-->
        <!-- <div class="chart-selector">
            <h4>Select Chart</h4>
            <label><input type="radio" name="chartType" value="pie-chart" checked> Pie Chart</label><br>
            <label><input type="radio" name="chartType" value="bar-chart"> Bar Chart</label><br>
            <label><input type="radio" name="chartType" value="horizontal-bar-chart"> Horizontal Chart</label><br>
            <label><input type="radio" name="chartType" value="nodelink-chart"> Node Link</label><br>
            <label><input type="radio" name="chartType" value="map-chart"> Map Chart</label><br>
            <button id="run">Run</button>
        </div> -->
        <bar-chart id="barChart1"></bar-chart>
        <!-- <pie-chart id="pieChart"></pie-chart> -->
        <!-- <nodelink-chart id="nodeLinkChart"></nodelink-chart> -->
        <bar-chart id="barChart2"></bar-chart>
        <bar-chart id="barChart3"></bar-chart>
        <bar-chart id="barChart4"></bar-chart>
        <bar-chart id="barChart5"></bar-chart>
        <map-chart id="mapChart1"></map-chart>
        <map-chart id="mapChart2"></map-chart>

    </div>
    <script>

        // Function make query for PieData
        async function fetchPieData() {
            const query = `
                PREFIX dbpprop: <http://dbpedia.org/property/>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                PREFIX yago: <http://dbpedia.org/class/yago/>
                PREFIX dbo: <http://dbpedia.org/ontology/>
                PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

                SELECT DISTINCT ?name ?population (SAMPLE(?lang) AS ?randomLang)
                WHERE {
                ?country a dbo:Country ;
                        rdfs:label ?enName ;
                        dbo:language [ rdfs:label ?lang ] .
                
                OPTIONAL { ?country dbpprop:populationEstimate ?popEstimate. }
                OPTIONAL { ?country dbpprop:populationCensus ?popCensus. }
                BIND(coalesce(?popEstimate, ?popCensus) AS ?populationRaw)
                
                FILTER (
                    EXISTS { ?country (dbpprop:iso3166code|dbpprop:iso31661Alpha|dbpprop:countryCode) ?code }
                    || EXISTS { ?country a yago:MemberStatesOfTheUnitedNations }
                )
                
                FILTER(langMatches(lang(?enName), "en"))
                
                BIND(
                    IF(datatype(?populationRaw) = xsd:integer,
                    ?populationRaw,
                    xsd:integer(?populationRaw)
                    ) AS ?population
                )
                FILTER(BOUND(?population))
                
                BIND(str(?enName) AS ?name)
                }
                GROUP BY ?name ?population
                LIMIT 10
            `;
            return await fetchSPARQLData(query);
        }
        
        // Function make query for BarData
        async function fetchBarData() {
            const query = `
                PREFIX dbpprop: <http://dbpedia.org/property/>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
                PREFIX yago: <http://dbpedia.org/class/yago/>
                PREFIX dbo: <http://dbpedia.org/ontology/>
                PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>

                SELECT DISTINCT ?name ?population (SAMPLE(?lang) AS ?randomLang)
                WHERE {
                ?country a dbo:Country ;
                        rdfs:label ?enName ;
                        dbo:language [ rdfs:label ?lang ] .
                
                OPTIONAL { ?country dbpprop:populationEstimate ?popEstimate. }
                OPTIONAL { ?country dbpprop:populationCensus ?popCensus. }
                BIND(coalesce(?popEstimate, ?popCensus) AS ?populationRaw)
                
                FILTER (
                    EXISTS { ?country (dbpprop:iso3166code|dbpprop:iso31661Alpha|dbpprop:countryCode) ?code }
                    || EXISTS { ?country a yago:MemberStatesOfTheUnitedNations }
                )
                
                FILTER(langMatches(lang(?enName), "en"))
                
                BIND(
                    IF(datatype(?populationRaw) = xsd:integer,
                    ?populationRaw,
                    xsd:integer(?populationRaw)
                    ) AS ?population
                )
                FILTER(BOUND(?population))
                
                BIND(str(?enName) AS ?name)
                }
                GROUP BY ?name ?population
                LIMIT 10
            `;
            return await fetchSPARQLData(query);
        }

        // Function make query for BarData
        async function fetchStackedBarData() {
            const query = `
                PREFIX dbo: <http://dbpedia.org/ontology/>
                PREFIX dct: <http://purl.org/dc/terms/>

                SELECT ?year (COUNT(?film) AS ?count) ?genre
                WHERE {
                ?film a dbo:Film ;
                        dbo:releaseDate ?releaseDate ;
                        dbo:genre ?genreResource .
                ?genreResource rdfs:label ?genre .
                
                FILTER (LANG(?genre) = 'en')
                
                BIND (YEAR(?releaseDate) AS ?year)
                }
                GROUP BY ?year ?genre
                ORDER BY ?year ?genre
                
                LIMIT 20
            `;
            return await fetchSPARQLData(query);
        }

        // Funtion to make query for Node link
        async function fetchNodeLinkData() {
            const query = `
                PREFIX dbo: <http://dbpedia.org/ontology/>
                PREFIX dbr: <http://dbpedia.org/resource/>
                PREFIX foaf: <http://xmlns.com/foaf/0.1/>
                PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>

                SELECT ?band ?bandName ?member ?memberName WHERE {
                    ?band dbo:genre dbr:Punk_rock ;
                        foaf:name ?bandName ;
                        dbo:bandMember ?member .

                    ?member foaf:name ?memberName .

                    FILTER(langMatches(lang(?bandName), "en") && langMatches(lang(?memberName), "en"))
                }
                LIMIT 10
            `;

            return await fetchSPARQLData(query);
        }
        
        // Function to parse node-link data from JSON
        function parseNodeLinkJSON(jsonData) {
            let nodes = new Map();
            let links = [];

            for (let result of jsonData) {
                // console.log("Processing result:", result);
                // Access directly to required fields
                let band = result.band?.value;
                let bandName = result.bandName?.value;
                let member = result.member?.value;
                let memberName = result.memberName?.value;

                if (!nodes.has(bandName)) nodes.set(bandName, { id: nodes.size + 1, name: bandName });
                if (!nodes.has(memberName)) nodes.set(memberName, { id: nodes.size + 1, name: memberName });

                links.push({
                    source: nodes.get(bandName).id,
                    target: nodes.get(memberName).id
                });
            }

            return { nodes: Array.from(nodes.values()), links };
        }
        
        // Function to get SPARQLData
        async function fetchSPARQLData(query) {
            const endpointUrl = "https://dbpedia.org/sparql";
            const url = `${endpointUrl}?query=${encodeURIComponent(query)}`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/sparql-results+json' }
                });

                const jsonData = await response.json();

                return jsonData.results ? jsonData.results.bindings : [];
            } catch (error) {
                console.error("Error fetching SPARQL data:", error);
                return [];
            }
        }

        // Function to make query for Map Chart
        async function fetchMapData() {
            const query = `
                PREFIX bd: <http://www.bigdata.com/rdf#>
                PREFIX wd: <http://www.wikidata.org/entity/>
                PREFIX wdt: <http://www.wikidata.org/prop/direct/>
                PREFIX wikibase: <http://wikiba.se/ontology#>

                SELECT DISTINCT ?countryLabel ?population ?isoCode
                WHERE {
                    ?country wdt:P31 wd:Q6256 ;   # Get the countryLabel
                            wdt:P1082 ?population ;  # Get population
                            wdt:P298 ?isoCode .  # Get ISO Code 3166-1 alpha-3
                    SERVICE wikibase:label { bd:serviceParam wikibase:language "en" }
                }
                ORDER BY DESC(?population)
            `;

            return await fetchWikidataSPARQL(query);
        }

        // Function to get WikiData
        async function fetchWikidataSPARQL(query) {
            const endpointUrl = "https://query.wikidata.org/sparql";
            const url = `${endpointUrl}?query=${encodeURIComponent(query)}&format=json`;

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/sparql-results+json' }
                });

                const jsonData = await response.json();
                return jsonData.results ? jsonData.results.bindings : [];
            } catch (error) {
                console.error("Error fetching Wikidata SPARQL data:", error);
                return [];
            }
        }

        // Function to update Chart
        async function updateCharts() {

            // // Pie chart
            // const pieData = await fetchPieData();
            // document.querySelector('#pieChart').setAttribute('data', JSON.stringify({
            //     description: "Pie chart - Countries with the largest population",
            //     width: 400,
            //     height: 400,
            //     data: [{ values: pieData.map(d => ({ 
            //         country: d.name.value, 
            //         population: d.population.value, 
            //         language: d.randomLang.value 
            //     })) }],
            //     encoding: [
            //         { text: { "field": "country" } },
            //         { theta: { "field": "population" } },
            //         { color: { "field": "language" } },
            //         // { radius: { "field": "population", "scale": { "type": "sqrt", "zero": true, "rangeMin": 20 } } }
            //     ]
            // }));

            // Single vertical bar chart
            const barData1 = await fetchBarData();
            document.querySelector('#barChart1').setAttribute('data', JSON.stringify({
                "description": "Single Vertical - Population of countries",
                "width": 400,
                "height": 400,
                
                "data": [{ "values": barData1.map(d => ({ 
                    "country": d.name.value, 
                    "population": +d.population.value, 
                    "language": d.randomLang.value,
                    })) }],
                "encoding": {
                    "x": { "field": "country"},
                    "y": { "field": "population",
                            "scale": {
                                "type": "log",
                                // "exponent": 0.5
                            }
                        },
                    "color": { 
                        "field": "language",
                        // "scale": [ "#c7c7c7", "#aec7e8", "#1f77b4", "#9467bd", "#e7ba52"],
                        // "scale": d3.schemePastel1,
                        // "scale": d3.schemeSet2,
                        // "scale": d3.schemeOrRd[9],
                        "scale": {
                            // "domain": ["Belarusian language", "French language", "لغة تشيلوبا", "Russian language", "English language", "Mongolian language", "Romani language", "Angolar language", "Persian language"],
                            "range": d3.schemePaired
                        },
                        // "scale": d3.interpolateRdYlBu,
                        "title": "Language" 
                    },
                    "direction": "vertical",
                }
            }));
            console.log("BAR-1", JSON.stringify(barData1, null, 2));

            // Single horizontal bar chart
            const barData2 = await fetchBarData();
            document.querySelector('#barChart2').setAttribute('data', JSON.stringify({
                "description": "Single Horizontal - Population of countries",
                "width": 400,
                "height": 400,
                
                "data": [{ "values": [
                        {"x": 0, "y": 1}, {"x": 1, "y": 10},
                        {"x": 2, "y": 100}, {"x": 3, "y": 1000},
                        {"x": 4, "y": 10000}, {"x": 5, "y": 100000},
                        {"x": 6, "y": 1000000}, {"x": 7, "y": 10000000}
                ] }],
                "encoding": {
                    "x": { "field": "x"},
                    "y": { "field": "y", 
                            "scale": {
                                "type": "log",
                            }
                        },
                    
                    // "color": { 
                    //     "field": "language", 
                    //     "scale": {
                    //         "domain": ["Belarusian language", "French language", "لغة تشيلوبا", "Russian language", "English language", "Mongolian language", "Romani language", "Angolar language", "Persian language"],
                    //         "range": d3.schemePastel1
                    //     },
                    //     "title": "Language"  
                    // },
                    // "direction": "horizontal",
                }
            }));

            // Stacked vertical bar chart
            const barData3 = await fetchStackedBarData();
            document.querySelector('#barChart3').setAttribute('data', JSON.stringify({
                "description": "Stacked Vertical - Number of films per year",
                "width": 400, 
                "height": 400,
                "data": [{ "values": barData3.map(d => ({ 
                    "year": d.year.value, 
                    "count": d.count?.value ? +d.count.value : 0, 
                    "genre": d.genre.value,
                    })) }],
                "encoding": {
                    "x": { "field": "year" },
                    "y": { "field": "count" },
                    // "y": { "field": "count",
                    //         "scale": {
                    //             "type": "pow",
                    //             "exponent": 0.5
                    //         }},
                    "color": {
                        "field": "genre", 
                        "scale": {
                            "domain": ["Children's television series", "Soap opera", "Drama", "Situation comedy", "Music", "Anthology series", "Traditional pop", "Sitcom", "Adventure", "Historical drama", "Animation", "Comedy"],
                            "range": d3.schemePaired
                        },
                        // "scale": [ "#c7c7c7", "#aec7e8", "#1f77b4", "#9467bd", "#e7ba52"],
                        "title": "Movie genre" 
                    },
                    "stack": true,
                    "direction": "vertical"
                }
            }));
            console.log("BAR-3", JSON.stringify(barData3, null, 2));


            // Percentage Stacked bar chart
            const barData4 = await fetchStackedBarData();
            // console.log("BAR-4", JSON.stringify(barData4, null, 2));
            document.querySelector('#barChart4').setAttribute('data', JSON.stringify({
                "description": "Percentage Stacked - Number of films per year",
                "width": 400,
                "height": 400,
                // stack: "true",
                // direction: "horizontal",
                "data": [{ "values": barData4.map(d => ({ 
                    "year": d.year.value, 
                    "count": d.count?.value ? +d.count.value : 0, 
                    "genre": d.genre.value,
                    })) }],
                "encoding": {
                    "x": { "field": "year" } ,
                    "y": { "field": "count" } ,
                    "color": {
                        "field": "genre",
                        "scale": {
                            "domain": ["Children's television series", "Soap opera", "Drama", "Situation comedy", "Music", "Anthology series", "Traditional pop", "Sitcom", "Adventure", "Historical drama", "Animation", "Comedy"],
                            "range": d3.schemePaired
                        },
                        "title": "Movie genre" 
                    },
                    "stack": "normalize",
                    // direction: "horizontal"
                }
            }));

            //  Grouped Vertical Bar Chart
            const barData5 = await fetchStackedBarData();
            document.querySelector('#barChart5').setAttribute('data', JSON.stringify({
                "description": "Grouped Vertical Bar Chart",
                "width": 800,
                "height": 400,
                "data": [{ "values": barData5.map(d => ({ 
                    "year": d.year.value, 
                    "count": d.count?.value ? +d.count.value : 0, 
                    "genre": d.genre.value,
                    })) }],
                "encoding": {
                    "x": { "field": "year" },
                    "y": { "field": "count" },
                    "color": {
                        "field": "genre",
                        "scale": {
                            "domain": ["Children's television series", "Soap opera", "Drama", "Situation comedy", "Music", "Anthology series", "Traditional pop", "Sitcom", "Adventure", "Historical drama", "Animation", "Comedy"],
                            "range": d3.schemePaired
                        },
                        // "scale": ["#e7ba52", "#c7c7c7", "#aec7e8"],
                        "title": "Movie Genre" 
                    },
                    "stack": false,
                    // "direction": "horizontal"
                }
            }));
            // console.log("BAR-4", JSON.stringify(bar5, null, 2));

            // const nodeLinkData = await fetchNodeLinkData();
            // const parsedNodeLink = parseNodeLinkJSON(nodeLinkData);
            
            // document.querySelector('#nodeLinkChart').setAttribute('data', JSON.stringify({
            //     description: "Node-Link Chart - Punk Rock Bands & Members",
            //     width: 600,
            //     height: 400,
            //     nodes: parsedNodeLink.nodes,
            //     links: parsedNodeLink.links
            // }));

            const mapData1 = await fetchMapData();
            document.querySelector('#mapChart1').setAttribute('data', JSON.stringify({
                "description": "Map Chart - Population of Countries",
                "width": 600,
                "height": 600,
                                "bubble": "true",

                "data": {
                    "url": "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson",
                    // "format": {
                    // "type": "topojson",
                    // "feature": "countries"
                    // }
                },
                "transform": [
                    {
                    "lookup": "id",
                    "from": {
                        "data": {
                        "values": mapData1.map(d => ({
                            "id": d.isoCode.value,
                            "country": d.countryLabel.value,
                            "population": +d.population.value
                        }))
                        },
                        "key": "id",
                        "fields": ["population", "country"]
                    }
                    }
                ],
                "projection": {
                    "type": "mercator"
                },
                "mark": "geoshape",
                "encoding": {
                    "color": {
                    "field": "population",
                    "type": "quantitative"
                    },
                }
            }));
            // console.log("BAR-4", JSON.stringify(mapData, null, 2));

            const mapData2 = await fetchMapData();
            document.querySelector('#mapChart2').setAttribute('data', JSON.stringify({
                "width": 1000,
                "height": 600,
                // "bubble": "true",
                // "connection": "true",
                "hexbin": "true",
                "data": {
                    // "url": "https://github.com/d3/d3-geo/blob/main/test/data/us-10m.json"
                    "url": "https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson"
                },
                "transform": [
                    {
                    "from": {
                        "data": {
                        "values": [
                            { "id": "JFK", "latitude": 40.6413, "longitude": -73.7781 },
                            { "id": "LAX", "latitude": 33.9416, "longitude": -118.4085 },
                            { "id": "ORD", "latitude": 41.9742, "longitude": -87.9073 }
                        ]
                        }
                    },
                    "to": {
                        "data": {
                        "values": [
                            { "origin": "JFK", "destination": "LAX" },
                            { "origin": "JFK", "destination": "ORD" },
                            { "origin": "LAX", "destination": "ORD" }
                        ]
                        }
                    }
                    }
                ]
            }));
        }
        // Call updateCharts() when the page is loaded
        document.addEventListener('DOMContentLoaded', updateCharts);
                
    </script>
  </body>
</html>